<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processed Followers - Niko Labeler</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <a href="/" class="link-button" style="margin-bottom: 20px;">‚Üê Back to Dashboard</a>
    <div class="card">
      <h2>Processed Followers</h2>
      <div class="description">
        List of all followers that have been labeled.
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <input type="text" id="search-input" placeholder="Search followers..." style="width: 100%;">
      </div>

      <ul id="followers-list" class="user-list" style="max-height: 600px; overflow-y: auto;">
        <!-- Populated by JS -->
      </ul>
      <div id="loading-indicator" style="text-align: center; padding: 20px; display: none;">Loading more...</div>
    </div>
  </div>
  <script>
    let currentPage = 1;
    let currentSearch = "";
    let isLoading = false;
    let hasMore = true;
    const list = document.getElementById('followers-list');
    const loadingIndicator = document.getElementById('loading-indicator');
    const searchInput = document.getElementById('search-input');

    // Debounce search
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = e.target.value;
            resetList();
            fetchFollowers();
        }, 300);
    });

    function resetList() {
        currentPage = 1;
        hasMore = true;
        list.innerHTML = '';
    }

    async function fetchFollowers() {
      if (isLoading || !hasMore) return;
      isLoading = true;
      loadingIndicator.style.display = 'block';

      try {
        const res = await fetch(`/api/followers?page=${currentPage}&limit=50&search=${encodeURIComponent(currentSearch)}`);
        const data = await res.json();
        
        if (data.items.length === 0 && currentPage === 1) {
            list.innerHTML = '<li class="user-item" style="justify-content: center;">No followers found.</li>';
            hasMore = false;
        } else {
            renderFollowers(data.items);
            hasMore = data.hasMore;
            currentPage++;
        }

      } catch (e) {
        console.error("Failed to fetch followers", e);
      } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
      }
    }

    function renderFollowers(users) {
        users.forEach(user => {
          const li = document.createElement('li');
          li.className = 'user-item';
          
          // Make clickable
          const link = document.createElement('a');
          link.href = `https://bsky.app/profile/${user.handle}`;
          link.target = "_blank";
          link.style.display = "flex";
          link.style.alignItems = "center";
          link.style.width = "100%";
          link.style.textDecoration = "none";
          link.style.color = "inherit";

          const icon = document.createElement('div');
          icon.className = 'user-icon';
          
          if (user.avatar) {
              const img = document.createElement('img');
              img.src = user.avatar;
              img.alt = user.handle;
              icon.appendChild(img);
          } else {
              icon.textContent = user.handle ? user.handle[0].toUpperCase() : '?';
          }
          
          const info = document.createElement('div');
          info.className = 'user-info';
          
          const handleDiv = document.createElement('div');
          handleDiv.className = 'user-handle';
          handleDiv.textContent = user.handle;
          
          const didDiv = document.createElement('div');
          didDiv.className = 'user-did';
          didDiv.textContent = user.did;
          
          info.appendChild(handleDiv);
          info.appendChild(didDiv);
          
          // Following info
          const followingDiv = document.createElement('div');
          followingDiv.className = 'user-following';
          if (user.following && user.following.length > 0) {
              followingDiv.innerHTML = `<span>Following:</span> ${user.following.join(', ')}`;
          }

          link.appendChild(icon);
          link.appendChild(info);
          link.appendChild(followingDiv); // Add to link
          li.appendChild(link);
          list.appendChild(li);
        });
    }

    // Infinite Scroll
    list.addEventListener('scroll', () => {
        if (list.scrollTop + list.clientHeight >= list.scrollHeight - 50) {
            fetchFollowers();
        }
    });

    // Initial load
    fetchFollowers();
  </script>
</body>
</html>
